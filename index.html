<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TWO ACID HOUSES</title>

  <!-- p5 HEAD content (unchanged) -->
  <style>
    /* .................. Your existing CSS .................. */
    
    /* Force #particle-overlay to ignore clicks entirely: */
    #particle-overlay {
      pointer-events: none; /* ensures it never blocks user clicks */
    }
    
    /* Force the black bar or settings section to a high z-index if needed: */
    #media-control-hub {
      z-index: 9999; /* ensure it's above the p5 canvas or overlays */
    }

    #settings-dropdown {
      display: none;
      position: absolute;
      bottom: 100%;  /* open upward */
      right: 0;
      margin-bottom: 10px;
      background-color: #fff;
      color: #000;
      border: 2px solid #000;
      border-radius: 4px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 99999; /* extremely high to guarantee it's on top */
    }
  </style>
</head>
<body>
  <!-- LOADER OVERLAY -->
  <div id="loader">
    <div class="loading-text">Loading...</div>
  </div>

  <!-- HOME PAGE -->
  <div id="home-page" class="page-container fadeable">
    <div id="interactive-container-home"></div>
    <div id="static-top">NEW<br>MURALS<br>FOR<br>TWO</div>
    <div id="static-bottom">HOUSES</div>
    <button id="enter-code-btn">Enter Transmission Code</button>

    <!-- Password Modal -->
    <div id="password-modal" class="modal">
      <div class="modal-content">
        <span class="close" id="modal-close">&times;</span>
        <div id="update-text">Enter designated launch code...<span id="blinking-dot">.</span></div>
        <br />
        <input type="password" id="modal-password" placeholder="....." />
        <br />
        <button id="modal-submit">ACTIVATE Transmission RELAY</button>
      </div>
    </div>
  </div>

  <!-- GALLERY PAGE -->
  <div id="gallery-page" class="page-container fadeable invisible hidden">
    <!-- Insert Audio (with controls for debugging) -->
    <audio id="my-audio" src="assets/NMTAH_Side_A.m4a" controls style="display:none;"></audio>
  
    <!-- Media Control Hub -->
    <div id="media-control-hub">
      <div id="media-controls">
        <button id="play-pause" class="control-button" title="Toggle Connection">
          <span id="play-pause-text">Connect</span>
        </button>
        <button id="rewind-btn" class="control-button" title="Rewind Transmission">
          Rewind Transmission
        </button>
        <div id="digital-counter">00:00:00:000</div>
        <div id="led-indicator" class="light-off" title="Signal Indicator"></div>
        <div id="divider">|</div>
      </div>
      <div id="settings-section">
        <button id="settings-btn" title="Settings">&#9881;</button>
        <div id="settings-dropdown">
          <button id="download-btn" class="dropdown-button">Retrieve Audio Transition</button>
          <button id="placeholder-btn" class="dropdown-button">Consult Training Manual</button>
          <button id="reset-session" class="dropdown-button">Reset Transmission Connection</button>
          <button id="return-home" class="dropdown-button">Return Home</button>
        </div>
      </div>
    </div>

    <div id="video-container">
      <video id="loop-video" autoplay loop muted playsinline>
        <source id="video-source" src="assets/sand_4_loop.mp4" type="video/mp4" />
      </video>
    </div>
  </div>

  <!-- Download & Placeholder Modals -->
  <div id="download-modal" class="modal">
    <div class="modal-content inverse">
      <span class="close" id="download-modal-close">&times;</span>
      <p>This is your full audio manifest. <br> Click the button below to download.</p>
      <a href="assets/NMTAH_Side_A.wav" download="NMTAH_Side_A.wav">
        <button>Download manifest</button>
      </a>
    </div>
  </div>
  <div id="placeholder-modal" class="modal">
    <div class="modal-content inverse">
      <span class="close" id="placeholder-modal-close">&times;</span>
      <p>Placeholder text. Replace this with your content later.</p>
    </div>
  </div>

  <!-- P5 ACID Letters Sketch -->
  <script>
    let homeSketch = function (p) {
      // ... your existing acid letters code ...
    };
    new p5(homeSketch);
  </script>

  <!-- Particle Overlay (with pointer-events: none) -->
  <style>#particle-overlay { pointer-events: none; }</style>
  <script>
    let particleSketch = function(p) {
      // ... your existing code for FFT-based visuals ...
    };
    if (!document.getElementById("particle-overlay")) {
      let particleDiv = document.createElement("div");
      particleDiv.id = "particle-overlay";
      document.body.appendChild(particleDiv);
    }
    new p5(particleSketch, "particle-overlay");
  </script>

  <!-- Main JS Logic -->
  <script>
    window.addEventListener("load", () => {
      console.log("Page loaded, attaching event listeners...");

      /* 
       * 1) Gather DOM elements 
       */
      const loader = document.getElementById("loader");
      const loaderText = document.querySelector("#loader .loading-text");
      const homePage = document.getElementById("home-page");
      const galleryPage = document.getElementById("gallery-page");

      // Password modal
      const passwordModal = document.getElementById("password-modal");
      const modalClose = document.getElementById("modal-close");
      const modalSubmit = document.getElementById("modal-submit");
      const modalPassword = document.getElementById("modal-password");

      // Buttons
      const enterCodeBtn = document.getElementById("enter-code-btn");
      const playPauseBtn = document.getElementById("play-pause");
      const playPauseText = document.getElementById("play-pause-text");
      const rewindBtn = document.getElementById("rewind-btn");
      const ledIndicator = document.getElementById("led-indicator");
      const digitalCounter = document.getElementById("digital-counter");

      const settingsSection = document.getElementById("settings-section");
      const settingsBtn = document.getElementById("settings-btn");
      const settingsDropdown = document.getElementById("settings-dropdown");

      const downloadButton = document.getElementById("download-btn");
      const placeholderButton = document.getElementById("placeholder-btn");
      const resetSessionBtn = document.getElementById("reset-session");
      const returnHomeBtn = document.getElementById("return-home");
      const disconnectBtn = document.getElementById("disconnect-btn");
      const downloadModalClose = document.getElementById("download-modal-close");
      const placeholderModalClose = document.getElementById("placeholder-modal-close");

      // The audio element
      const audio = document.getElementById("my-audio");

      /*
       * 2) Home Page - Password Logic
       */
      enterCodeBtn.addEventListener("click", () => {
        console.log("Enter Transmission Code button clicked");
        if (localStorage.getItem("passwordAccepted") === "true") {
          showGallery();
        } else {
          passwordModal.style.display = "flex";
          modalPassword.value = "";
          modalPassword.focus();
        }
      });

      modalClose.addEventListener("click", () => {
        passwordModal.style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target === passwordModal) {
          passwordModal.style.display = "none";
        }
      });
      modalSubmit.addEventListener("click", checkPassword);
      modalPassword.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          checkPassword();
        }
      });

      function checkPassword() {
        const entered = modalPassword.value;
        const correctPassword = "qwerty";
        if (entered === correctPassword) {
          localStorage.setItem("passwordAccepted", "true");
          passwordModal.style.display = "none";
          showGallery();
        } else {
          alert("ACCESS RESTRICTED: Launch code does not match records. Consult mission control documentation.");
        }
      }

      /*
       * 3) Media Controls
       */
      playPauseText.textContent = "Connect";
      ledIndicator.classList.add("light-off");

      function safeAudio() {
        if (!audio) {
          console.error("Audio element not found!");
          return null;
        }
        return audio;
      }

      playPauseBtn.addEventListener("click", () => {
        const a = safeAudio();
        if (!a) return;
        console.log("Play/Pause clicked. paused =", a.paused);
        if (a.paused) {
          a.play().then(() => {
            console.log("audio.play() resolved, currentTime =", a.currentTime);
            playPauseText.textContent = "Connected...";
            ledIndicator.classList.remove("light-off");
            ledIndicator.classList.add("light-active");
          }).catch(err => {
            console.warn("audio.play() failed:", err);
          });
        } else {
          a.pause();
          console.log("audio.pause() called, currentTime =", a.currentTime);
          playPauseText.textContent = "Connect";
          ledIndicator.classList.remove("light-active");
          ledIndicator.classList.add("light-off");
        }
      });

      rewindBtn.addEventListener("click", () => {
        const a = safeAudio();
        if (!a) return;
        a.currentTime = Math.max(0, a.currentTime - 10);
        console.log("Rewind -10s. currentTime now =", a.currentTime);
        updateCounter();
      });

      function updateCounter() {
        if (!audio) return;
        let t = audio.currentTime;
        let hours = Math.floor(t / 3600);
        let minutes = Math.floor((t % 3600) / 60);
        let seconds = Math.floor(t % 60);
        let ms = Math.floor((t - Math.floor(t)) * 1000);
        digitalCounter.innerText = 
          String(hours).padStart(2,'0') + ":" +
          String(minutes).padStart(2,'0') + ":" +
          String(seconds).padStart(2,'0') + ":" +
          String(ms).padStart(3,'0');
      }
      setInterval(updateCounter, 50);

      // Disconnect
      disconnectBtn.addEventListener("click", showHome);

      /*
       * 4) Settings Cog
       */
      settingsBtn.addEventListener("click", () => {
        console.log("Settings cog clicked!");
        if (settingsDropdown.style.display === "block") {
          settingsDropdown.style.display = "none";
        } else {
          settingsDropdown.style.display = "block";
        }
      });
      window.addEventListener("click", (e) => {
        if (!settingsSection.contains(e.target)) {
          settingsDropdown.style.display = "none";
        }
      });

      // Reset Session
      resetSessionBtn.addEventListener("click", () => {
        if (confirm("Are you sure: This will break your existing connection and require you to resubmit your transition code")) {
          localStorage.removeItem("passwordAccepted");
          alert("Connection reset. Please re-enter your transmission code on the Home page.");
        }
      });

      // Return Home (keeps localStorage)
      returnHomeBtn.addEventListener("click", () => {
        showHome();
      });

      /*
       * 5) Download & Placeholder Modals
       */
      downloadButton.addEventListener("click", () => {
        document.getElementById("download-modal").style.display = "flex";
      });
      placeholderButton.addEventListener("click", () => {
        document.getElementById("placeholder-modal").style.display = "flex";
      });
      downloadModalClose.addEventListener("click", () => {
        document.getElementById("download-modal").style.display = "none";
      });
      placeholderModalClose.addEventListener("click", () => {
        document.getElementById("placeholder-modal").style.display = "none";
      });
      window.addEventListener("click", (e) => {
        if (e.target === document.getElementById("download-modal")) {
          document.getElementById("download-modal").style.display = "none";
        }
        if (e.target === document.getElementById("placeholder-modal")) {
          document.getElementById("placeholder-modal").style.display = "none";
        }
      });

      /*
       * 6) Loading Overlay + Page Switchers
       */
      function showLoading(message) {
        if (loader && loaderText) {
          loaderText.innerHTML = message;
          loader.style.display = "flex";
        }
      }
      function hideLoading() {
        if (loader) {
          loader.style.display = "none";
        }
      }

      function showGallery() {
        console.log("Showing gallery...");
        showLoading("TRANSMITTING ACTIVATION CODES TO NEAREST RELAY STATION....<br>PLEASE STAND BY");
        homePage.classList.remove("invisible");
        homePage.offsetWidth;
        homePage.classList.add("invisible");

        // Use sand_4_loop video exclusively
        const chosenSource = "assets/sand_4_loop.mp4";
        const videoSourceElem = document.getElementById("video-source");
        videoSourceElem.src = chosenSource;
        document.getElementById("loop-video").load();

        setTimeout(() => {
          showLoading("ACCESS GRANTED");
          setTimeout(() => {
            homePage.classList.add("hidden");
            galleryPage.classList.remove("hidden");
            galleryPage.offsetWidth;
            galleryPage.classList.remove("invisible");
            hideLoading();
          }, 2000);
        }, 3000);
      }

      function showHome() {
        if (audio && !audio.paused) {
          audio.pause();
          playPauseText.textContent = "Connect";
          ledIndicator.classList.remove("light-active");
          ledIndicator.classList.add("light-off");
        }
        showLoading("Bringing you back down....");
        galleryPage.classList.remove("invisible");
        galleryPage.offsetWidth;
        galleryPage.classList.add("invisible");

        setTimeout(() => {
          galleryPage.classList.add("hidden");
          homePage.classList.remove("hidden");
          homePage.offsetWidth;
          homePage.classList.remove("invisible");
          hideLoading();
        }, 3000);
      }
    });
  </script>
</body>
</html>
